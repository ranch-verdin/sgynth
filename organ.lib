import("stdfaust.lib");
import("svf.lib");

my_env(gate) = en.are(attack,release,gate) with {
};

partial(f,N) = os.osccos(f * N *(1 + 0.002 * no.lfnoise(f * N / 10.0)));

harmonics(partials,f) = partial(f,1)*a1 + partial(f,2)*a2 + partial(f,3)*a3 + partial(f,4)*a4 + partial(f,5)*a5 + partial(f,6)*a6 + partial(f,8)*a8 with {
  a1 = partials : _,!,!,!,!,!,! ;
  a2 = partials : !,_,!,!,!,!,! ;
  a3 = partials : !,!,_,!,!,!,! ;
  a4 = partials : !,!,!,_,!,!,! ;
  a5 = partials : !,!,!,!,_,!,! ;
  a6 = partials : !,!,!,!,!,_,! ;
  a8 = partials : !,!,!,!,!,!,_ ;
};

basic(partials,attack,release,vibrato,freq,gate) = harmonics(partials,freq*(1 + vibrato * os.osccos(5))) * en.are(attack,release,gate);

organ_aux(freq,gate,vibrato,attack,release,colour,drive,a1,a2,a3,a4,a5,a6,a8) =
  basic(partials,attack,release,vibrato,freq,gate) : *(drive)
  : fi.lowpass(2,6000) : +(colour) : tanh : -(colour): fi.dcblockerat(5) with {
  partials = a1,a2,a3,a4,a5,a6,a8 ;
};

organ = hgroup("organ",
	       par(i,4,vibrato,attack,release,colour,drive,a1,a2,a3,a4,a5,a6,a8):
	       (hgroup("voice1",organ_aux(freq, gate)),hgroup("voice2",organ_aux(freq, gate)),hgroup("voice3",organ_aux(freq, gate)),hgroup("voice4",organ_aux(freq, gate))) :>
	       *(vslider("vol", 0.1, 0.0,2.0,0.01)): tanh ) with {
  freq = vslider("freq", 100.0, 10.0, 5000.0, 0.1);
  gate = button("gate");
    a1 = vslider("a1", 0.5, 0.0, 1.0, 0.01);
    a2 = vslider("a2", 0.5, 0.0, 1.0, 0.01);
    a3 = vslider("a3", 0.5, 0.0, 1.0, 0.01);
    a4 = vslider("a4", 0.5, 0.0, 1.0, 0.01);
    a5 = vslider("a5", 0.5, 0.0, 1.0, 0.01);
    a6 = vslider("a6", 0.5, 0.0, 1.0, 0.01);
    a8 = vslider("a8", 0.5, 0.0, 1.0, 0.01);
    vibrato = vslider("vibrato",1,0.0,10,0.1) * 0.01;
    attack = vslider("attack",1,0.1,100,0.1) * 0.001;
    release = vslider("release",1,0.1,1000,0.1) * 0.001;
    colour = vslider("colour", 0.1, 0.0, 1.0, 0.01);
    drive = vslider("drive", 0.1, 0.0,2.0,0.01);
};
